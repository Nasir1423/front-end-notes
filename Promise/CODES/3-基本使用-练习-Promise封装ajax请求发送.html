<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promise 封装 AJAX 请求</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h2 class="page-header">Promise 封装 AJAX 请求</h2>
        <button class="btn btn-primary" id="btn">点击发送 AJAX 请求</button>
        <br>
        <p id="poem"></p>
        <script>
            const btn = document.querySelector('#btn');
            const p = document.querySelector('#poem');
            let xhr = null; // 声明 xhr 对象，作用是避免重复发送请求

            btn.addEventListener('click', () => {
                // 如果存在之前的请求，则先取消之前的请求
                if (xhr) xhr.abort();

                // 异步操作代码
                const promise = new Promise((resolve, reject) => {
                    // 创建对象
                    xhr = new XMLHttpRequest();
                    // 初始化：设置请求方法和请求 URL
                    xhr.open('GET', 'http://127.0.0.1:9000/getPoem');
                    // 发送请求
                    xhr.send();
                    // 响应结果处理
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4) {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                resolve(xhr.response); // 成功时调用
                            } else {
                                reject(xhr.status); // 失败时调用
                            }
                        }
                    }
                });

                promise.then((value) => {
                    p.style.color = 'black';
                    p.innerText = value;
                }, (reason) => {
                    p.style.color = 'red';
                    p.innerText = 'ERROR:' + reason;
                });
            });
        </script>
    </div>
</body>

</html>